<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¹ãƒ¬ãƒƒãƒ‰ãƒãƒ£ãƒƒãƒˆ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* slate-300 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #f1f5f9; /* slate-100 */
        }
        /* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã«ãƒ›ãƒãƒ¼ã—ãŸæ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .reaction-button:hover .reaction-picker {
            opacity: 1;
            transform: translateY(-100%);
            visibility: visible;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="app" class="flex flex-col flex-grow max-w-4xl mx-auto w-full bg-white shadow-xl rounded-lg overflow-hidden my-4 sm:my-8 relative">

        <!-- Header -->
        <header class="bg-indigo-600 text-white p-4 shadow-md flex justify-between items-center">
            <h1 class="text-xl font-bold">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ»ã‚¹ãƒ¬ãƒƒãƒ‰</h1>
            <div id="loadingIndicator" class="text-sm font-semibold opacity-0 transition-opacity">æ¥ç¶šä¸­...</div>
        </header>

        <!-- Messages Area -->
        <div id="messagesContainer" class="flex-grow p-4 space-y-4 overflow-y-auto max-h-[70vh] custom-scrollbar">
            <!-- Messages will be rendered here -->
            <div class="text-center text-gray-500 mt-8" id="initialMessage">
                æ¥ç¶šä¸­...
            </div>
        </div>
        
        <!-- Input Form Footer -->
        <footer class="p-4 border-t border-gray-200 bg-gray-50">
            <div class="mb-3 text-xs text-gray-600 truncate">
                ã‚ãªãŸã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ : <span id="currentUserNameDisplay" class="font-semibold text-green-700 bg-green-100 px-1 py-0.5 rounded-md">æœªè¨­å®š</span>
                <span id="userIdHint" class="ml-2 text-gray-400 hidden sm:inline">(ID: <span id="currentUserIdDisplay">èª­ã¿è¾¼ã¿ä¸­...</span>)</span>
            </div>

            <!-- Reply Preview Area -->
            <div id="replyPreviewContainer" class="mb-3 p-2 bg-indigo-100 border-l-4 border-indigo-500 rounded-md flex justify-between items-start hidden">
                <div class="flex-grow min-w-0 pr-4">
                    <span class="text-xs font-semibold text-indigo-700 block">è¿”ä¿¡å…ˆ: <span id="replySenderName" class="font-normal"></span></span>
                    <p id="replyTextPreview" class="text-sm text-indigo-800 truncate"></p>
                </div>
                <button id="clearReplyButton" class="flex-shrink-0 text-indigo-500 hover:text-indigo-700 p-1 rounded-full hover:bg-indigo-200 transition">
                    <!-- Close Icon (SVG) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            
            <!-- Image Preview Area -->
            <div id="imagePreviewContainer" class="mb-3 p-3 border-t border-gray-200 bg-gray-100 rounded-lg hidden">
                <div class="flex items-center justify-between p-2 bg-yellow-50 border border-yellow-300 rounded-lg shadow-inner">
                    <div class="flex items-center">
                        <img id="imagePreview" class="h-12 w-12 object-cover rounded mr-3 border border-gray-300" src="" alt="ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
                        <span id="imageFileName" class="text-sm font-medium text-gray-700 truncate">ãƒ•ã‚¡ã‚¤ãƒ«å.jpg</span>
                    </div>
                    <button id="clearImageButton" class="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-yellow-100 transition">
                        <!-- Close Icon (SVG) -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <p class="text-xs text-red-600 mt-1">â€» Firestoreã®åˆ¶é™ï¼ˆ1MBï¼‰ã®ãŸã‚ã€ç”»åƒã¯è‡ªå‹•çš„ã«ç¸®å°ãƒ»åœ§ç¸®ã•ã‚Œã¾ã™ã€‚</p>
            </div>
            
            <!-- Error Message Modal (Custom alert alternative) -->
            <div id="errorMessageContainer" class="hidden mb-3 p-3 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-md transition duration-300 transform scale-95 opacity-0">
                <p id="errorMessageText" class="font-medium text-sm"></p>
            </div>

            <form id="messageForm" class="flex space-x-3">
                
                <!-- File Input Button -->
                <label class="flex items-center justify-center p-3 bg-gray-200 rounded-xl hover:bg-gray-300 transition duration-150 cursor-pointer shadow-sm disabled:bg-gray-200" title="ç”»åƒã‚’é¸æŠ">
                    <input type="file" id="imageFile" accept="image/*" class="hidden" disabled>
                    <!-- Image Icon (SVG) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-12 5h12a2 2 0 002-2V7a2 2 0 00-2-2H6a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                </label>

                <input
                    type="text"
                    id="messageInput"
                    placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¾ãŸã¯ç”»åƒã‚’é€ä¿¡..."
                    class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm disabled:bg-gray-200"
                >
                <button
                    type="submit"
                    id="sendButton"
                    disabled
                    class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-indigo-700 transition duration-200 ease-in-out shadow-md disabled:bg-indigo-300 flex items-center justify-center"
                >
                    é€ä¿¡
                </button>
            </form>
        </footer>
    </div>

    <!-- Nickname Modal Overlay -->
    <div id="nicknameModal" class="absolute inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm m-4 transform transition-all duration-300 scale-100">
            <h2 class="text-xl font-bold text-indigo-600 mb-4">ã‚ˆã†ã“ãï¼ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç™»éŒ²</h2>
            <p class="text-sm text-gray-600 mb-6">
                ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã«ã€ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚
            </p>
            <form id="nicknameForm">
                <input
                    type="text"
                    id="nicknameInput"
                    placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  (ä¾‹: åŒ¿åã•ã‚“, Taro)"
                    maxlength="20"
                    required
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm"
                >
                <button
                    type="submit"
                    class="mt-4 w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 transition duration-200 shadow-md"
                >
                    æ±ºå®š
                </button>
            </form>
        </div>
    </div>
    
    <!-- Canvas for Image Resizing (Hidden) -->
    <canvas id="imageCanvas" class="hidden"></canvas>

    <!-- Firebase Imports -->
    <script type="module">
        // Firebaseã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            query, 
            orderBy, 
            serverTimestamp,
            setLogLevel,
            doc,
            getDoc,
            setDoc,
            updateDoc, // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ç”¨
            deleteField // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‰Šé™¤ç”¨
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestoreã®ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’è¨­å®š
        setLogLevel('Debug');

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦æä¾›ã•ã‚Œã‚‹è¨­å®šã®å–å¾—
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let currentUserId = null;
        let currentUserName = null; // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let isAuthReady = false;
        let selectedImageBase64 = null; // é¸æŠã•ã‚ŒãŸç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let selectedImageFileName = null; // é¸æŠã•ã‚ŒãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let replyToMessage = null; // è¿”ä¿¡å¯¾è±¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æƒ…å ±ã‚’ä¿æŒ

        // UIè¦ç´ 
        const messagesContainer = document.getElementById('messagesContainer');
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const currentUserIdDisplay = document.getElementById('currentUserIdDisplay');
        const currentUserNameDisplay = document.getElementById('currentUserNameDisplay');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const initialMessage = document.getElementById('initialMessage');
        
        // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ é–¢é€£ã®UI
        const nicknameModal = document.getElementById('nicknameModal');
        const nicknameForm = document.getElementById('nicknameForm');
        const nicknameInput = document.getElementById('nicknameInput');

        // ç”»åƒé–¢é€£ã®UI
        const imageFileInput = document.getElementById('imageFile');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const imageFileNameDisplay = document.getElementById('imageFileName');
        const clearImageButton = document.getElementById('clearImageButton');
        const imageCanvas = document.getElementById('imageCanvas');

        // ãƒªãƒ—ãƒ©ã‚¤é–¢é€£ã®UI
        const replyPreviewContainer = document.getElementById('replyPreviewContainer');
        const replySenderName = document.getElementById('replySenderName');
        const replyTextPreview = document.getElementById('replyTextPreview');
        const clearReplyButton = document.getElementById('clearReplyButton');
        
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é–¢é€£ã®UI
        const errorMessageContainer = document.getElementById('errorMessageContainer');
        const errorMessageText = document.getElementById('errorMessageText');

        // å®šæ•°
        const SUPPORTED_REACTIONS = ['ğŸ‘', 'â¤ï¸', 'ğŸ˜‚', 'ğŸ”¥', 'ğŸ¥³', 'ğŸ¤”', 'ğŸ˜­', 'ğŸ™', 'ğŸ’¯', 'ğŸ’¡'];
        const MESSAGES_COLLECTION_PATH = `artifacts/${appId}/public/data/messages`;
        
        // â˜…â˜…â˜… å¤‰æ›´ç‚¹: ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‚’å®šç¾© â˜…â˜…â˜…
        const BANNED_WORDS = ['æ­»ã­', 'æ®ºã™', 'å¤©å®‰é–€', '198964', 'å¤©å®‰é–€äº‹ä»¶'];

        // Helper: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚«ã‚¹ã‚¿ãƒ UIã§è¡¨ç¤ºã™ã‚‹
        const displayError = (message) => {
            errorMessageText.textContent = message;
            errorMessageContainer.classList.remove('hidden');
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã€setTimeoutã‚’ä½¿ã£ã¦ã‚¯ãƒ©ã‚¹ã‚’å¤‰æ›´
            setTimeout(() => {
                errorMessageContainer.classList.remove('scale-95', 'opacity-0');
            }, 10); 

            // 5ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            setTimeout(() => {
                errorMessageContainer.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    errorMessageContainer.classList.add('hidden');
                }, 300); // transition duration
            }, 5000);
        };

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã®è¡¨ç¤º/éè¡¨ç¤ºã¨å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åˆ¶å¾¡
        const toggleLoading = (show) => {
            loadingIndicator.classList.toggle('opacity-100', show);
            loadingIndicator.classList.toggle('opacity-0', !show);
            
            const isDisabled = show || !currentUserName;
            messageInput.disabled = isDisabled;
            sendButton.disabled = isDisabled;
            imageFileInput.disabled = isDisabled; // ç”»åƒå…¥åŠ›ã‚‚åˆ¶å¾¡
        };
        
        // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å…¥åŠ›UIã®è¡¨ç¤º/éè¡¨ç¤º
        const toggleNicknameModal = (show) => {
            nicknameModal.classList.toggle('hidden', !show);
            if (show) {
                nicknameInput.focus();
            }
            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºä¸­ã¯ãƒ¡ã‚¤ãƒ³ã®å…¥åŠ›æ¬„ã¨ç”»åƒå…¥åŠ›ã‚’ç„¡åŠ¹åŒ–
            messageInput.disabled = show;
            sendButton.disabled = show;
            imageFileInput.disabled = show;
        }

        // Helper: æ—¥ä»˜ã‚’YYYY-MM-DDå½¢å¼ã®æ–‡å­—åˆ—ã§å–å¾—
        const getDateString = (date) => {
            if (!date) return '';
            return date.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' });
        };

        // =======================================================
        // ãƒªãƒ—ãƒ©ã‚¤æ©Ÿèƒ½é–¢é€£
        // =======================================================

        const setReplyTarget = (msg) => {
            replyToMessage = {
                messageId: msg.id,
                senderName: msg.senderName,
                textPreview: msg.type === 'text' ? msg.text.substring(0, 40) + (msg.text.length > 40 ? '...' : '') : 'ã€ç”»åƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€‘',
                type: msg.type
            };
            
            replySenderName.textContent = msg.senderName;
            replyTextPreview.textContent = replyToMessage.textPreview;
            replyPreviewContainer.classList.remove('hidden');
            messageInput.focus();
        };

        const clearReplyTarget = () => {
            replyToMessage = null;
            replyPreviewContainer.classList.add('hidden');
        };

        clearReplyButton.addEventListener('click', clearReplyTarget);

        // =======================================================
        // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ©Ÿèƒ½é–¢é€£
        // =======================================================

        const toggleReaction = async (messageId, emoji) => {
            if (!db || !currentUserId || !currentUserName) {
                console.warn('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ãã¾ã›ã‚“: èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            const messageRef = doc(db, MESSAGES_COLLECTION_PATH, messageId);
            
            try {
                // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã‚’å–å¾—ã—ã€ãƒˆã‚°ãƒ«ã™ã‚‹
                // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ§‹é€ : { 'ğŸ‘': { 'userId1': true, 'userId2': true }, 'â¤ï¸': { 'userId3': true } }
                const docSnap = await getDoc(messageRef);
                const currentReactions = docSnap.data().reactions || {};

                // ç‰¹å®šã®çµµæ–‡å­—ã«å¯¾ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ
                const emojiUsers = currentReactions[emoji] || {};
                
                let updateData = {};
                const userKey = currentUserId;
                const fieldPath = `reactions.${emoji}.${userKey}`;

                if (emojiUsers[userKey]) {
                    // æ—¢ã«ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã—ã¦ã„ã‚‹å ´åˆ -> å‰Šé™¤
                    updateData[fieldPath] = deleteField();
                    
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ãªããªã£ãŸå ´åˆã€çµµæ–‡å­—ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è‡ªä½“ã‚‚å‰Šé™¤ï¼ˆFirestoreã®Mapã¯ç©ºã®Mapã¨ã—ã¦æ®‹ã‚‹ãŒã€ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«deleteFieldã‚’ä½¿ã†ï¼‰
                } else {
                    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã—ã¦ã„ãªã„å ´åˆ -> è¿½åŠ 
                    updateData[fieldPath] = true;
                }
                
                // Firestoreã‚’æ›´æ–°
                await updateDoc(messageRef, updateData);
                console.log(`ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒˆã‚°ãƒ«ã—ã¾ã—ãŸ: ${emoji} on ${messageId}`);

            } catch (error) {
                console.error("ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
                displayError(`ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            }
        };


        // =======================================================
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        // =======================================================

        const renderMessages = (messages) => {
            // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            initialMessage.style.display = 'none';

            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’è¨˜æ†¶
            const shouldScroll = messagesContainer.scrollHeight - messagesContainer.clientHeight <= messagesContainer.scrollTop + 10;
            
            messagesContainer.innerHTML = '';
            
            if (messages.length === 0) {
                messagesContainer.innerHTML = '<div class="text-center text-gray-500 mt-8">ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ç¨¿ã—ã¾ã—ã‚‡ã†ï¼</div>';
                if (!currentUserName) toggleNicknameModal(true);
                return;
            }
            
            let lastDate = null;

            messages.forEach(msg => {
                const isMine = msg.userId === currentUserId;
                const senderName = msg.senderName || 'åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼'; 
                const date = msg.timestamp?.toDate ? msg.timestamp.toDate() : new Date();
                const currentDate = getDateString(date);

                // 1. æ—¥ä»˜åŒºåˆ‡ã‚Šç·šã®è¡¨ç¤º (ãã®æ—¥æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆ)
                if (currentDate !== lastDate) {
                    const dateSeparator = document.createElement('div');
                    dateSeparator.className = 'flex items-center my-6';
                    dateSeparator.innerHTML = `
                        <div class="flex-grow border-t border-gray-300"></div>
                        <span class="flex-shrink mx-4 text-xs text-gray-500 font-semibold bg-gray-100 px-3 py-1 rounded-full shadow-sm">
                            ${currentDate}
                        </span>
                        <div class="flex-grow border-t border-gray-300"></div>
                    `;
                    messagesContainer.appendChild(dateSeparator);
                    lastDate = currentDate;
                }

                // 2. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬ä½“ã®ã‚³ãƒ³ãƒ†ãƒŠ
                const messageContainer = document.createElement('div');
                messageContainer.className = `flex ${isMine ? 'justify-end' : 'justify-start'} mb-2`;

                const contentAndReactionWrapper = document.createElement('div');
                contentAndReactionWrapper.className = 'relative flex flex-col items-start max-w-xs sm:max-w-sm md:max-w-md';

                const contentDiv = document.createElement('div');
                contentDiv.className = `p-3 rounded-xl shadow-md cursor-pointer ${
                    isMine 
                        ? 'bg-indigo-500 text-white rounded-tr-none' 
                        : 'bg-gray-200 text-gray-800 rounded-tl-none'
                } transition duration-300`;
                
                // ãƒªãƒ—ãƒ©ã‚¤æ©Ÿèƒ½ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¯ãƒªãƒƒã‚¯ã§è¿”ä¿¡å¯¾è±¡ã‚’è¨­å®šï¼‰
                contentDiv.addEventListener('click', () => {
                    setReplyTarget(msg);
                });
                
                // 2.1. è¿”ä¿¡å…ˆï¼ˆReply Toï¼‰ã®è¡¨ç¤º
                if (msg.replyTo) {
                    const replyToDiv = document.createElement('div');
                    replyToDiv.className = `p-2 mb-2 rounded-lg border-l-2 ${isMine ? 'border-indigo-200 bg-indigo-400' : 'border-indigo-500 bg-gray-100'}`;
                    replyToDiv.innerHTML = `
                        <span class="text-xs font-semibold ${isMine ? 'text-indigo-100' : 'text-indigo-600'}">
                            ${msg.replyTo.senderName}ã¸ã®è¿”ä¿¡
                        </span>
                        <p class="text-sm truncate ${isMine ? 'text-white' : 'text-gray-700'}">
                            ${msg.replyTo.textPreview}
                        </p>
                    `;
                    contentAndReactionWrapper.appendChild(replyToDiv);
                }

                // 2.2. ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã®è¡¨ç¤º
                const nameSpan = document.createElement('span');
                nameSpan.className = `block text-xs font-semibold mb-1 truncate ${isMine ? 'text-indigo-200' : 'text-indigo-700'}`;
                nameSpan.textContent = isMine ? `ã‚ãªãŸ (${senderName})` : senderName;
                contentDiv.appendChild(nameSpan);

                // 2.3. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ (ãƒ†ã‚­ã‚¹ãƒˆã¾ãŸã¯ç”»åƒ)
                if (msg.type === 'text') {
                    const textP = document.createElement('p');
                    textP.className = 'break-words whitespace-pre-wrap';
                    textP.textContent = msg.text;
                    contentDiv.appendChild(textP);
                } else if (msg.type === 'image' && msg.imageData) {
                    const img = document.createElement('img');
                    img.src = msg.imageData;
                    img.alt = msg.text || 'é€ä¿¡ã•ã‚ŒãŸç”»åƒ';
                    img.className = 'max-w-full h-auto rounded-lg shadow-md border border-gray-300 transition transform duration-300';
                    contentDiv.appendChild(img);
                    
                    if (msg.text && msg.text.trim().length > 0) {
                        const captionP = document.createElement('p');
                        captionP.className = 'break-words whitespace-pre-wrap mt-2 text-sm italic';
                        captionP.textContent = msg.text;
                        contentDiv.appendChild(captionP);
                    }
                }

                // 2.4. ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆç§’ã¾ã§ï¼‰
                const timeSpan = document.createElement('span');
                timeSpan.className = `block mt-1 text-right text-xs ${isMine ? 'text-indigo-200' : 'text-gray-500'}`;
                timeSpan.textContent = date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                contentDiv.appendChild(timeSpan);

                contentAndReactionWrapper.appendChild(contentDiv);

                // 3. ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢
                const reactions = msg.reactions || {};
                const reactionKeys = Object.keys(reactions);
                
                if (reactionKeys.length > 0) {
                    const reactionBubble = document.createElement('div');
                    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ–ãƒ«ã®ä½ç½®ã‚’èª¿æ•´
                    reactionBubble.className = `absolute flex space-x-1 p-1 rounded-full bg-white shadow-lg border border-gray-200 transform ${isMine ? 'left-0 -bottom-3 translate-x-1' : 'right-0 -bottom-3 -translate-x-1'}`;
                    
                    reactionKeys.forEach(emoji => {
                        const users = reactions[emoji];
                        const count = users ? Object.keys(users).length : 0;
                        if (count > 0) {
                            const isUserReacted = users[currentUserId];
                            const reactionItem = document.createElement('span');
                            reactionItem.className = `flex items-center text-xs font-semibold px-2 py-0.5 rounded-full cursor-pointer transition ${isUserReacted ? 'bg-yellow-200 border-2 border-yellow-500' : 'bg-gray-100 hover:bg-gray-200'}`;
                            reactionItem.innerHTML = `${emoji} ${count}`;
                            reactionItem.title = `${emoji}: ${Object.keys(users).map(uid => uid.substring(0, 8)).join(', ')}`;

                            // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒˆã‚°ãƒ«ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                            reactionItem.addEventListener('click', (e) => {
                                e.stopPropagation(); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬ä½“ã®ã‚¯ãƒªãƒƒã‚¯ï¼ˆãƒªãƒ—ãƒ©ã‚¤ï¼‰ã‚’é˜²ã
                                toggleReaction(msg.id, emoji);
                            });
                            reactionBubble.appendChild(reactionItem);
                        }
                    });
                    
                    if (reactionBubble.children.length > 0) {
                         contentAndReactionWrapper.appendChild(reactionBubble);
                    }
                }

                // 4. ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ”ãƒƒã‚«ãƒ¼ãƒœã‚¿ãƒ³
                const reactionButton = document.createElement('button');
                reactionButton.className = `reaction-button absolute z-10 p-1 rounded-full text-xs text-gray-500 hover:text-indigo-600 transition duration-150 group ${isMine ? 'right-full mr-2' : 'left-full ml-2'}`;
                reactionButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01m-1.414 7.379v-2.121A4.004 4.004 0 0012 15a4.004 4.004 0 002.828 1.178V17.38c.683-.69.957-1.465 1.096-2.298a.999.999 0 00-.282-1.22l-1.414-1.414a.999.999 0 00-1.22-.282c-.833.139-1.608.413-2.298 1.096zM12 20a8 8 0 100-16 8 8 0 000 16z" />
                    </svg>
                    <div class="reaction-picker absolute top-0 left-1/2 -translate-x-1/2 mt-1 -translate-y-0 opacity-0 invisible group-hover:visible group-hover:opacity-100 transition-all duration-300 ease-in-out bg-white p-1 rounded-full shadow-xl flex space-x-1 border border-gray-200">
                        ${SUPPORTED_REACTIONS.map(emoji => `
                            <span data-emoji="${emoji}" class="reaction-emoji text-lg cursor-pointer hover:bg-gray-100 p-1 rounded-full transition leading-none">
                                ${emoji}
                            </span>
                        `).join('')}
                    </div>
                `;
                reactionButton.setAttribute('data-message-id', msg.id);

                // ãƒ”ãƒƒã‚«ãƒ¼å†…ã®çµµæ–‡å­—ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                reactionButton.querySelectorAll('.reaction-emoji').forEach(emojiSpan => {
                    emojiSpan.addEventListener('click', (e) => {
                        e.stopPropagation(); // è¦ªãƒœã‚¿ãƒ³ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬ä½“ã®ã‚¯ãƒªãƒƒã‚¯ã‚’é˜²ã
                        const clickedEmoji = e.target.getAttribute('data-emoji');
                        toggleReaction(msg.id, clickedEmoji);
                    });
                });

                contentAndReactionWrapper.appendChild(reactionButton);

                // å…¨ã¦ã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ 
                // è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã¯ã€ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ”ãƒƒã‚«ãƒ¼ã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å·¦å´ã«ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬ä½“ã‚’å³å´ã«é…ç½®ã™ã‚‹ãŸã‚ã€flex-row-reverseã‚’ä½¿ã†
                if (isMine) {
                    messageContainer.className = `flex justify-end mb-2`;
                    contentAndReactionWrapper.classList.remove('items-start');
                    contentAndReactionWrapper.classList.add('items-end');
                }

                messageContainer.appendChild(contentAndReactionWrapper);
                messagesContainer.appendChild(messageContainer);
            });

            // ä¸€ç•ªä¸‹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            if (shouldScroll || messages.length === 1) { 
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        };


        // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å–å¾—ã—ã€è¨­å®šã•ã‚Œã¦ã„ãªã‘ã‚Œã°å…¥åŠ›ã‚’ä¿ƒã™
        const checkAndRequestNickname = async () => {
            if (!db || !currentUserId) return;

            const usersCollectionPath = `artifacts/${appId}/public/data/users`;
            const userDocRef = doc(db, usersCollectionPath, currentUserId);

            try {
                const docSnap = await getDoc(userDocRef);
                
                if (docSnap.exists() && docSnap.data().nickname) {
                    currentUserName = docSnap.data().nickname;
                    currentUserNameDisplay.textContent = currentUserName;
                    toggleLoading(false);
                    toggleNicknameModal(false);
                } else {
                    currentUserName = null;
                    currentUserNameDisplay.textContent = 'æœªè¨­å®š';
                    toggleLoading(false);
                    toggleNicknameModal(true); 
                    imageFileInput.disabled = true;
                }
            } catch (error) {
                console.error("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã®å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                initialMessage.textContent = `ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }
        };

        // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã®ä¿å­˜
        const saveNickname = async (nickname) => {
            if (!db || !currentUserId || !nickname.trim()) return;

            // â˜…â˜…â˜… å¤‰æ›´ç‚¹: ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã«ã‚‚ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚’é©ç”¨ â˜…â˜…â˜…
            const normalizedNickname = nickname.trim().toLowerCase();
            const bannedWordUsed = BANNED_WORDS.some(word => normalizedNickname.includes(word));
            
            if (bannedWordUsed) {
                displayError('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã«ä¸é©åˆ‡ãªè¡¨ç¾ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            // â˜…â˜…â˜… å¤‰æ›´ç‚¹ã“ã“ã¾ã§ â˜…â˜…â˜…

            const usersCollectionPath = `artifacts/${appId}/public/data/users`;
            const userDocRef = doc(db, usersCollectionPath, currentUserId);

            try {
                await setDoc(userDocRef, { nickname: nickname.trim() }, { merge: true });
                currentUserName = nickname.trim();
                currentUserNameDisplay.textContent = currentUserName;
                toggleNicknameModal(false);
                toggleLoading(false); 
            } catch (error) {
                console.error("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
                displayError(`ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            }
        };

        // Firebaseã®åˆæœŸåŒ–ã¨èªè¨¼
        const initializeFirebase = async () => {
            try {
                toggleLoading(true);
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // èªè¨¼çŠ¶æ…‹ã®å¤‰æ›´ã‚’ç›£è¦–
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        currentUserIdDisplay.textContent = currentUserId;
                        isAuthReady = true;
                        initialMessage.textContent = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...';

                        // èªè¨¼å®Œäº†å¾Œã«ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ãƒ‡ãƒ¼ã‚¿ç›£è¦–ã‚’é–‹å§‹
                        checkAndRequestNickname();
                        setupFirestoreListener();
                    } else {
                        initialMessage.textContent = 'ã‚µã‚¤ãƒ³ã‚¤ãƒ³å‡¦ç†ä¸­...';
                    }
                });

                // ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ã¾ãŸã¯åŒ¿åèªè¨¼ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebaseã®åˆæœŸåŒ–ã¾ãŸã¯èªè¨¼ã‚¨ãƒ©ãƒ¼:", error);
                initialMessage.textContent = `åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                toggleLoading(false);
            }
        };

        // Firestoreã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        const setupFirestoreListener = () => {
            if (!db || !isAuthReady) return;

            const messagesCol = collection(db, MESSAGES_COLLECTION_PATH);
            
            const q = query(messagesCol, orderBy('timestamp', 'asc'));

            onSnapshot(q, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                renderMessages(messages);
            }, (error) => {
                console.error("Firestoreãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼:", error);
                initialMessage.textContent = `ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            });
        };
        
        // =======================================================
        // ç”»åƒå‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯
        // =======================================================

        const MAX_IMAGE_SIZE = 800; // ç”»åƒã®æœ€å¤§è¾ºã®ã‚µã‚¤ã‚º (px)
        const COMPRESSION_QUALITY = 0.7; // åœ§ç¸®å“è³ª (0.0 - 1.0)
        
        /**
         * ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€ãƒªã‚µã‚¤ã‚ºã—ã¦Base64ã«å¤‰æ›ã™ã‚‹
         */
        const resizeAndEncodeImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = imageCanvas;
                        const ctx = canvas.getContext('2d');
                        
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_IMAGE_SIZE) {
                                height *= MAX_IMAGE_SIZE / width;
                                width = MAX_IMAGE_SIZE;
                            }
                        } else {
                            if (height > MAX_IMAGE_SIZE) {
                                width *= MAX_IMAGE_SIZE / height;
                                height = MAX_IMAGE_SIZE;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        
                        ctx.drawImage(img, 0, 0, width, height);
                        const base64Image = canvas.toDataURL('image/jpeg', COMPRESSION_QUALITY);
                        
                        resolve(base64Image);
                    };
                    img.onerror = reject;
                    img.src = event.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
        imageFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) {
                clearSelectedImage();
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) { 
                displayError("ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆ5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ï¼‰ã€‚");
                clearSelectedImage();
                return;
            }

            toggleLoading(true);
            try {
                selectedImageBase64 = await resizeAndEncodeImage(file);
                selectedImageFileName = file.name;

                imagePreview.src = selectedImageBase64;
                imageFileNameDisplay.textContent = selectedImageFileName;
                imagePreviewContainer.classList.remove('hidden');

                messageInput.placeholder = 'ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ (ä»»æ„) ã‚’å…¥åŠ›...';
                
            } catch (error) {
                console.error("ç”»åƒå‡¦ç†ã‚¨ãƒ©ãƒ¼:", error);
                displayError("ç”»åƒã®èª­ã¿è¾¼ã¿ã¾ãŸã¯ãƒªã‚µã‚¤ã‚ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                clearSelectedImage();
            } finally {
                toggleLoading(false);
            }
        });

        // ç”»åƒé¸æŠè§£é™¤ã®å‡¦ç†
        const clearSelectedImage = () => {
            selectedImageBase64 = null;
            selectedImageFileName = null;
            imageFileInput.value = ''; 
            imagePreviewContainer.classList.add('hidden');
            messageInput.placeholder = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¾ãŸã¯ç”»åƒã‚’é€ä¿¡...';
            messageInput.focus();
        };
        
        clearImageButton.addEventListener('click', clearSelectedImage);


        // =======================================================
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å‡¦ç†
        // =======================================================
        const sendMessage = async (text) => {
            if (!db || !currentUserId || !currentUserName) {
                console.warn('é€ä¿¡ã§ãã¾ã›ã‚“: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã€ã¾ãŸã¯ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚');
                if (!currentUserName) toggleNicknameModal(true);
                return;
            }

            const messageText = text.trim();
            const isImageMessage = selectedImageBase64 !== null;
            const isReply = replyToMessage !== null;

            if (!messageText && !isImageMessage) {
                return; 
            }
            
            // â˜…â˜…â˜… å¤‰æ›´ç‚¹: ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã®ãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜…
            if (messageText) {
                const normalizedText = messageText.toLowerCase();
                const bannedWordFound = BANNED_WORDS.some(word => normalizedText.includes(word));
                
                if (bannedWordFound) {
                    displayError('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ä¸é©åˆ‡ãªè¡¨ç¾ãŒå«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€é€ä¿¡ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
                    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã¯ãƒ­ã‚°ã—ãªã„
                    messageInput.value = '';
                    return; 
                }
            }
            // â˜…â˜…â˜… å¤‰æ›´ç‚¹ã“ã“ã¾ã§ â˜…â˜…â˜…

            const messagesCol = collection(db, MESSAGES_COLLECTION_PATH);

            try {
                messageInput.disabled = true;
                sendButton.disabled = true;
                
                let messageData = {
                    userId: currentUserId,
                    senderName: currentUserName,
                    timestamp: serverTimestamp(),
                    reactions: {} // åˆæœŸãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
                };

                if (isImageMessage) {
                    Object.assign(messageData, {
                        type: 'image',
                        imageData: selectedImageBase64,
                        text: messageText, 
                        fileName: selectedImageFileName
                    });
                    clearSelectedImage(); 
                } else {
                    Object.assign(messageData, {
                        type: 'text',
                        text: messageText,
                    });
                }
                
                // ãƒªãƒ—ãƒ©ã‚¤æƒ…å ±ã‚’è¿½åŠ 
                if (isReply) {
                    messageData.replyTo = replyToMessage;
                    clearReplyTarget();
                }

                await addDoc(messagesCol, messageData);
                messageInput.value = ''; // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢

            } catch (error) {
                console.error("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼:", error);
                displayError(`ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                if (error.message.includes('maximum size')) {
                    console.error('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç”»åƒãŒå¤§ãã™ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚åˆ¥ã®å°ã•ãªç”»åƒã‚’è©¦ã—ã¦ãã ã•ã„ã€‚');
                }
            } finally {
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.focus();
            }
        };

        // ãƒ•ã‚©ãƒ¼ãƒ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            sendMessage(messageInput.value);
        });

        // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        nicknameForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const nickname = nicknameInput.value;
            if (nickname) {
                saveNickname(nickname);
            }
        });

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹å§‹
        window.onload = initializeFirebase;
    </script>
</body>
</html>
